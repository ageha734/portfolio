#!/usr/bin/env bun
// @bun
var hn=Object.create;var{getPrototypeOf:gn,defineProperty:Z,getOwnPropertyNames:dn}=Object;var fn=Object.prototype.hasOwnProperty;var W=(t,n,s)=>{s=t!=null?hn(gn(t)):{};let e=n||!t||!t.__esModule?Z(s,"default",{value:t,enumerable:!0}):s;for(let a of dn(t))if(!fn.call(e,a))Z(e,a,{get:()=>t[a],enumerable:!0});return e};var pn=(t,n)=>()=>(n||t((n={exports:{}}).exports,n),n.exports);var O=pn((zt,U)=>{var N=process||{},D=N.argv||[],M=N.env||{},In=!(!!M.NO_COLOR||D.includes("--no-color"))&&(!!M.FORCE_COLOR||D.includes("--color")||N.platform==="win32"||(N.stdout||{}).isTTY&&M.TERM!=="dumb"||!!M.CI),Sn=(t,n,s=t)=>(e)=>{let a=""+e,r=a.indexOf(n,t.length);return~r?t+Pn(a,n,s,r)+n:t+a+n},Pn=(t,n,s,e)=>{let a="",r=0;do a+=t.substring(r,e)+s,r=e+n.length,e=t.indexOf(n,r);while(~e);return a+t.substring(r)},nn=(t=In)=>{let n=t?Sn:()=>String;return{isColorSupported:t,reset:n("\x1B[0m","\x1B[0m"),bold:n("\x1B[1m","\x1B[22m","\x1B[22m\x1B[1m"),dim:n("\x1B[2m","\x1B[22m","\x1B[22m\x1B[2m"),italic:n("\x1B[3m","\x1B[23m"),underline:n("\x1B[4m","\x1B[24m"),inverse:n("\x1B[7m","\x1B[27m"),hidden:n("\x1B[8m","\x1B[28m"),strikethrough:n("\x1B[9m","\x1B[29m"),black:n("\x1B[30m","\x1B[39m"),red:n("\x1B[31m","\x1B[39m"),green:n("\x1B[32m","\x1B[39m"),yellow:n("\x1B[33m","\x1B[39m"),blue:n("\x1B[34m","\x1B[39m"),magenta:n("\x1B[35m","\x1B[39m"),cyan:n("\x1B[36m","\x1B[39m"),white:n("\x1B[37m","\x1B[39m"),gray:n("\x1B[90m","\x1B[39m"),bgBlack:n("\x1B[40m","\x1B[49m"),bgRed:n("\x1B[41m","\x1B[49m"),bgGreen:n("\x1B[42m","\x1B[49m"),bgYellow:n("\x1B[43m","\x1B[49m"),bgBlue:n("\x1B[44m","\x1B[49m"),bgMagenta:n("\x1B[45m","\x1B[49m"),bgCyan:n("\x1B[46m","\x1B[49m"),bgWhite:n("\x1B[47m","\x1B[49m"),blackBright:n("\x1B[90m","\x1B[39m"),redBright:n("\x1B[91m","\x1B[39m"),greenBright:n("\x1B[92m","\x1B[39m"),yellowBright:n("\x1B[93m","\x1B[39m"),blueBright:n("\x1B[94m","\x1B[39m"),magentaBright:n("\x1B[95m","\x1B[39m"),cyanBright:n("\x1B[96m","\x1B[39m"),whiteBright:n("\x1B[97m","\x1B[39m"),bgBlackBright:n("\x1B[100m","\x1B[49m"),bgRedBright:n("\x1B[101m","\x1B[49m"),bgGreenBright:n("\x1B[102m","\x1B[49m"),bgYellowBright:n("\x1B[103m","\x1B[49m"),bgBlueBright:n("\x1B[104m","\x1B[49m"),bgMagentaBright:n("\x1B[105m","\x1B[49m"),bgCyanBright:n("\x1B[106m","\x1B[49m"),bgWhiteBright:n("\x1B[107m","\x1B[49m")}};U.exports=nn();U.exports.createColors=nn});import{EventEmitter as bn}from"events";function q(t){return t==null?[]:Array.isArray(t)?t:[t]}function xn(t,n,s,e){var a,r=t[n],i=~e.string.indexOf(n)?s==null||s===!0?"":String(s):typeof s==="boolean"?s:~e.boolean.indexOf(n)?s==="false"?!1:s==="true"||(t._.push((a=+s,a*0===0)?a:s),!!s):(a=+s,a*0===0)?a:s;t[n]=r==null?i:Array.isArray(r)?r.concat(i):[r,i]}function wn(t,n){t=t||[],n=n||{};var s,e,a,r,i,m={_:[]},c=0,u=0,o=0,g=t.length;let x=n.alias!==void 0,j=n.unknown!==void 0,Y=n.default!==void 0;if(n.alias=n.alias||{},n.string=q(n.string),n.boolean=q(n.boolean),x)for(s in n.alias){e=n.alias[s]=q(n.alias[s]);for(c=0;c<e.length;c++)(n.alias[e[c]]=e.concat(s)).splice(c,1)}for(c=n.boolean.length;c-- >0;){e=n.alias[n.boolean[c]]||[];for(u=e.length;u-- >0;)n.boolean.push(e[u])}for(c=n.string.length;c-- >0;){e=n.alias[n.string[c]]||[];for(u=e.length;u-- >0;)n.string.push(e[u])}if(Y){for(s in n.default)if(r=typeof n.default[s],e=n.alias[s]=n.alias[s]||[],n[r]!==void 0){n[r].push(s);for(c=0;c<e.length;c++)n[r].push(e[c])}}let R=j?Object.keys(n.alias):[];for(c=0;c<g;c++){if(a=t[c],a==="--"){m._=m._.concat(t.slice(++c));break}for(u=0;u<a.length;u++)if(a.charCodeAt(u)!==45)break;if(u===0)m._.push(a);else if(a.substring(u,u+3)==="no-"){if(r=a.substring(u+3),j&&!~R.indexOf(r))return n.unknown(a);m[r]=!1}else{for(o=u+1;o<a.length;o++)if(a.charCodeAt(o)===61)break;r=a.substring(u,o),i=a.substring(++o)||(c+1===g||(""+t[c+1]).charCodeAt(0)===45||t[++c]),e=u===2?[r]:r;for(o=0;o<e.length;o++){if(r=e[o],j&&!~R.indexOf(r))return n.unknown("-".repeat(u)+r);xn(m,r,o+1<e.length||i,n)}}}if(Y){for(s in n.default)if(m[s]===void 0)m[s]=n.default[s]}if(x)for(s in m){e=n.alias[s]||[];while(e.length>0)m[e.shift()]=m[s]}return m}var E=(t)=>t.replace(/[<[].+/,"").trim(),$n=(t)=>{let n=/<([^>]+)>/g,s=/\[([^\]]+)\]/g,e=[],a=(m)=>{let c=!1,u=m[1];if(u.startsWith("..."))u=u.slice(3),c=!0;return{required:m[0].startsWith("<"),value:u,variadic:c}},r;while(r=n.exec(t))e.push(a(r));let i;while(i=s.exec(t))e.push(a(i));return e},On=(t)=>{let n={alias:{},boolean:[]};for(let[s,e]of t.entries()){if(e.names.length>1)n.alias[e.names[0]]=e.names.slice(1);if(e.isBoolean)if(e.negated){if(!t.some((r,i)=>{return i!==s&&r.names.some((m)=>e.names.includes(m))&&typeof r.required==="boolean"}))n.boolean.push(e.names[0])}else n.boolean.push(e.names[0])}return n},X=(t)=>{return t.sort((n,s)=>{return n.length>s.length?-1:1})[0]},K=(t,n)=>{return t.length>=n?t:`${t}${" ".repeat(n-t.length)}`},Cn=(t)=>{return t.replace(/([a-z])-([a-z])/g,(n,s,e)=>{return s+e.toUpperCase()})},kn=(t,n,s)=>{let e=0,a=n.length,r=t,i;for(;e<a;++e)i=r[n[e]],r=r[n[e]]=e===a-1?s:i!=null?i:!!~n[e+1].indexOf(".")||!(+n[e+1]>-1)?{}:[]},Wn=(t,n)=>{for(let s of Object.keys(n)){let e=n[s];if(e.shouldTransform){if(t[s]=Array.prototype.concat.call([],t[s]),typeof e.transformFunction==="function")t[s]=t[s].map(e.transformFunction)}}},Bn=(t)=>{let n=/([^\\\/]+)$/.exec(t);return n?n[1]:""},I=(t)=>{return t.split(".").map((n,s)=>{return s===0?Cn(n):n}).join(".")};class v extends Error{constructor(t){super(t);if(this.name=this.constructor.name,typeof Error.captureStackTrace==="function")Error.captureStackTrace(this,this.constructor);else this.stack=new Error(t).stack}}class S{constructor(t,n,s){if(this.rawName=t,this.description=n,this.config=Object.assign({},s),t=t.replace(/\.\*/g,""),this.negated=!1,this.names=E(t).split(",").map((e)=>{let a=e.trim().replace(/^-{1,2}/,"");if(a.startsWith("no-"))this.negated=!0,a=a.replace(/^no-/,"");return I(a)}).sort((e,a)=>e.length>a.length?1:-1),this.name=this.names[this.names.length-1],this.negated&&this.config.default==null)this.config.default=!0;if(t.includes("<"))this.required=!0;else if(t.includes("["))this.required=!1;else this.isBoolean=!0}}var vn=process.argv,An=`${process.platform}-${process.arch} node-${process.version}`;class y{constructor(t,n,s={},e){this.rawName=t,this.description=n,this.config=s,this.cli=e,this.options=[],this.aliasNames=[],this.name=E(t),this.args=$n(t),this.examples=[]}usage(t){return this.usageText=t,this}allowUnknownOptions(){return this.config.allowUnknownOptions=!0,this}ignoreOptionDefaultValue(){return this.config.ignoreOptionDefaultValue=!0,this}version(t,n="-v, --version"){return this.versionNumber=t,this.option(n,"Display version number"),this}example(t){return this.examples.push(t),this}option(t,n,s){let e=new S(t,n,s);return this.options.push(e),this}alias(t){return this.aliasNames.push(t),this}action(t){return this.commandAction=t,this}isMatched(t){return this.name===t||this.aliasNames.includes(t)}get isDefaultCommand(){return this.name===""||this.aliasNames.includes("!")}get isGlobalCommand(){return this instanceof G}hasOption(t){return t=t.split(".")[0],this.options.find((n)=>{return n.names.includes(t)})}outputHelp(){let{name:t,commands:n}=this.cli,{versionNumber:s,options:e,helpCallback:a}=this.cli.globalCommand,r=[{body:`${t}${s?`/${s}`:""}`}];if(r.push({title:"Usage",body:`  $ ${t} ${this.usageText||this.rawName}`}),(this.isGlobalCommand||this.isDefaultCommand)&&n.length>0){let c=X(n.map((u)=>u.rawName));r.push({title:"Commands",body:n.map((u)=>{return`  ${K(u.rawName,c.length)}  ${u.description}`}).join(`
`)}),r.push({title:"For more info, run any command with the `--help` flag",body:n.map((u)=>`  $ ${t}${u.name===""?"":` ${u.name}`} --help`).join(`
`)})}let m=this.isGlobalCommand?e:[...this.options,...e||[]];if(!this.isGlobalCommand&&!this.isDefaultCommand)m=m.filter((c)=>c.name!=="version");if(m.length>0){let c=X(m.map((u)=>u.rawName));r.push({title:"Options",body:m.map((u)=>{return`  ${K(u.rawName,c.length)}  ${u.description} ${u.config.default===void 0?"":`(default: ${u.config.default})`}`}).join(`
`)})}if(this.examples.length>0)r.push({title:"Examples",body:this.examples.map((c)=>{if(typeof c==="function")return c(t);return c}).join(`
`)});if(a)r=a(r)||r;console.log(r.map((c)=>{return c.title?`${c.title}:
${c.body}`:c.body}).join(`

`))}outputVersion(){let{name:t}=this.cli,{versionNumber:n}=this.cli.globalCommand;if(n)console.log(`${t}/${n} ${An}`)}checkRequiredArgs(){let t=this.args.filter((n)=>n.required).length;if(this.cli.args.length<t)throw new v(`missing required args for command \`${this.rawName}\``)}checkUnknownOptions(){let{options:t,globalCommand:n}=this.cli;if(!this.config.allowUnknownOptions){for(let s of Object.keys(t))if(s!=="--"&&!this.hasOption(s)&&!n.hasOption(s))throw new v(`Unknown option \`${s.length>1?`--${s}`:`-${s}`}\``)}}checkOptionValue(){let{options:t,globalCommand:n}=this.cli,s=[...n.options,...this.options];for(let e of s){let a=t[e.name.split(".")[0]];if(e.required){let r=s.some((i)=>i.negated&&i.names.includes(e.name));if(a===!0||a===!1&&!r)throw new v(`option \`${e.rawName}\` value is missing`)}}}}class G extends y{constructor(t){super("@@global@@","",{},t)}}var B=Object.assign;class P extends bn{constructor(t=""){super();this.name=t,this.commands=[],this.rawArgs=[],this.args=[],this.options={},this.globalCommand=new G(this),this.globalCommand.usage("<command> [options]")}usage(t){return this.globalCommand.usage(t),this}command(t,n,s){let e=new y(t,n||"",s,this);return e.globalCommand=this.globalCommand,this.commands.push(e),e}option(t,n,s){return this.globalCommand.option(t,n,s),this}help(t){return this.globalCommand.option("-h, --help","Display this message"),this.globalCommand.helpCallback=t,this.showHelpOnExit=!0,this}version(t,n="-v, --version"){return this.globalCommand.version(t,n),this.showVersionOnExit=!0,this}example(t){return this.globalCommand.example(t),this}outputHelp(){if(this.matchedCommand)this.matchedCommand.outputHelp();else this.globalCommand.outputHelp()}outputVersion(){this.globalCommand.outputVersion()}setParsedInfo({args:t,options:n},s,e){if(this.args=t,this.options=n,s)this.matchedCommand=s;if(e)this.matchedCommandName=e;return this}unsetMatchedCommand(){this.matchedCommand=void 0,this.matchedCommandName=void 0}parse(t=vn,{run:n=!0}={}){if(this.rawArgs=t,!this.name)this.name=t[1]?Bn(t[1]):"cli";let s=!0;for(let a of this.commands){let r=this.mri(t.slice(2),a),i=r.args[0];if(a.isMatched(i)){s=!1;let m=B(B({},r),{args:r.args.slice(1)});this.setParsedInfo(m,a,i),this.emit(`command:${i}`,a)}}if(s){for(let a of this.commands)if(a.name===""){s=!1;let r=this.mri(t.slice(2),a);this.setParsedInfo(r,a),this.emit("command:!",a)}}if(s){let a=this.mri(t.slice(2));this.setParsedInfo(a)}if(this.options.help&&this.showHelpOnExit)this.outputHelp(),n=!1,this.unsetMatchedCommand();if(this.options.version&&this.showVersionOnExit&&this.matchedCommandName==null)this.outputVersion(),n=!1,this.unsetMatchedCommand();let e={args:this.args,options:this.options};if(n)this.runMatchedCommand();if(!this.matchedCommand&&this.args[0])this.emit("command:*");return e}mri(t,n){let s=[...this.globalCommand.options,...n?n.options:[]],e=On(s),a=[],r=t.indexOf("--");if(r>-1)a=t.slice(r+1),t=t.slice(0,r);let i=wn(t,e);i=Object.keys(i).reduce((g,x)=>{return B(B({},g),{[I(x)]:i[x]})},{_:[]});let m=i._,c={"--":a},u=n&&n.config.ignoreOptionDefaultValue?n.config.ignoreOptionDefaultValue:this.globalCommand.config.ignoreOptionDefaultValue,o=Object.create(null);for(let g of s){if(!u&&g.config.default!==void 0)for(let x of g.names)c[x]=g.config.default;if(Array.isArray(g.config.type)){if(o[g.name]===void 0)o[g.name]=Object.create(null),o[g.name].shouldTransform=!0,o[g.name].transformFunction=g.config.type[0]}}for(let g of Object.keys(i))if(g!=="_"){let x=g.split(".");kn(c,x,i[g]),Wn(c,o)}return{args:m,options:c}}runMatchedCommand(){let{args:t,options:n,matchedCommand:s}=this;if(!s||!s.commandAction)return;s.checkUnknownOptions(),s.checkOptionValue(),s.checkRequiredArgs();let e=[];return s.args.forEach((a,r)=>{if(a.variadic)e.push(t.slice(r));else e.push(t[r])}),e.push(n),s.commandAction.apply(this,e)}}var T=(t="")=>new P(t);import{existsSync as A,readdirSync as Mn}from"fs";import{join as h,relative as L,resolve as p}from"path";var{$:l}=globalThis.Bun;function Nn(t=process.cwd()){let n=p(t),s=p("/");while(n!==s){let e=h(n,"package.json"),a=h(n,"turbo.json");if(A(e)&&A(a))return n;n=p(n,"..")}return process.cwd()}function Vn(){let t=process.argv.slice(2),n="lint",s="ts",e=!1,a=[];for(let r of t)if(r.startsWith("--check-type="))n=r.split("=")[1];else if(r.startsWith("--lint-type="))s=r.split("=")[1];else if(r==="--fix")e=!0;else if(!r.startsWith("--"))a.push(r);return{config:{checkType:n,lintType:s,isFix:e},files:a}}function jn(t,n){let s=p(n,t),e=L(n,s),a=[/^apps\/([^/]+)/,/^packages\/([^/]+)/,/^tooling\/([^/]+)/,/^testing\/([^/]+)/,/^scripts\/([^/]+)/];for(let r of a){let i=r.exec(e);if(i){let m=i[1];if(m)return m}}return null}function qn(t,n){switch(t){case"tsp":return[h(n,"packages/api/src/schema/")];case"md":return[h(n,"apps/wiki/docs/")];case"shell":{let s=h(n,".docker"),e=[];try{let a=Mn(s,{recursive:!0}).filter((r)=>r.endsWith(".sh")).map((r)=>h(s,r));e.push(...a)}catch{}return e}case"actions":return[h(n,".github/")];case"textlint":return[h(n,"apps/wiki/docs/")];default:return[h(n,"apps/*/app/"),h(n,"packages/*/src/"),h(n,"tooling/*/src/"),h(n,"testing/*/src/")]}}function yn(t){let n=t.replace(/\.(ts|tsx)$/,".test.$1");return A(n)?n:null}function Gn(t){let n=t.replace(/\.test\.(ts|tsx)$/,".$1");return A(n)?n:null}async function Ln(t,n){let s=p(n,t),e=h(n,"node_modules",".bin","vitest"),a=yn(s);if(!a)console.error(`Error: Test file not found for ${t}`),process.exit(1);await l`${e} run --coverage --coverage.include=${s} --coverage.threshold.lines=100 --coverage.threshold.functions=100 --coverage.threshold.branches=100 --coverage.threshold.statements=100 ${a}`.cwd(n).env({NODE_ENV:"test",PATH:process.env.PATH||""})}async function Un(t,n,s){if(n!=="ts")console.error(`Error: --lint-type=${n} is not supported for test. Only --lint-type=ts is supported.`),process.exit(1);let e=t.map((r)=>p(s,r)),a=h(s,"node_modules",".bin","vitest");await l`${a} run ${e}`.cwd(s).env({NODE_ENV:"test",PATH:process.env.PATH||""})}async function Hn(t,n,s){if(n!=="ts")console.error(`Error: --lint-type=${n} is not supported for coverage. Only --lint-type=ts is supported.`),process.exit(1);let e=h(s,"node_modules",".bin","vitest");if(t.length>0){let a=t.map((r)=>{let i=p(s,r);if(r.includes(".test."))return Gn(i);return i}).filter((r)=>r!==null);if(a.length===0)console.error("Error: No source files found"),process.exit(1);for(let r of a)await Ln(L(s,r),s);return}await l`${e} run --coverage`.cwd(s).env({NODE_ENV:"test",PATH:process.env.PATH||""})}async function _n(t,n,s,e,a){let r=e.map((i)=>p(a,i));if(n==="fmt"){if(s)await l`${t} format ${r}`.cwd(a);else await l`${t} format --check ${r}`.cwd(a);return}if(s)await l`${t} compile ${r}`.cwd(a);else await l`${t} compile ${r} --warn-as-error`.cwd(a)}function zn(t,n){if(t==="fmt")return n?"fmt":"fmt:check";return n?"lint:fix":"lint"}async function Jn(t,n,s,e){if(t.size===0)return;let r=Array.from(t).map((m)=>`--filter=${m}`).join(" "),i=zn(n,s);await l`turbo run ${i} ${r}`.cwd(e)}async function Qn(t,n,s,e,a){if(e.length===0)return;if(n==="fmt")if(s)await l`${t} check --write --only=formatter --organize-imports-enabled=true ${e}`.cwd(a);else await l`${t} check --only=formatter --organize-imports-enabled=true ${e}`.cwd(a);else if(s)await l`${t} check --write --only=linter --organize-imports-enabled=true ${e}`.cwd(a);else await l`${t} check --only=linter --organize-imports-enabled=true ${e}`.cwd(a)}async function Yn(t,n,s,e,a){let r=new Set,i=[];for(let m of e){let c=p(a,m),u=jn(c,a);if(u)r.add(u);else i.push(c)}await Jn(r,n,s,a),await Qn(t,n,s,i,a)}async function Rn(t,n,s,e){let a=s.map((i)=>p(e,i));if(t==="fmt"){if(n)await l`remark ${a} --output`.cwd(e);else await l`remark ${a} --frail --quiet`.cwd(e);return}let r=h(e,"node_modules",".bin","markdownlint-cli2");if(n)await l`${r} --fix ${a}`.cwd(e);else await l`${r} ${a}`.cwd(e)}async function Zn(t,n,s,e){let a=s.map((i)=>p(e,i));if(a.length===0){console.log("No shell files to check");return}if(t==="fmt"){if(n)await l`go run mvdan.cc/sh/v3/cmd/shfmt@v3.12.0 -w ${a}`.cwd(e);else await l`go run mvdan.cc/sh/v3/cmd/shfmt@v3.12.0 -l -d ${a}`.cwd(e);return}let r=a.map((i)=>L(e,i));await l`docker run --rm -v ${e}:/work -w /work -v ${e}/node_modules:/work/node_modules koalaman/shellcheck:v0.11.0 ${r}`}async function Xn(t,n,s,e){if(t==="fmt")console.error("Error: textlint does not support formatting. Use --check-type=lint instead."),process.exit(1);let a=s.map((i)=>p(e,i)),r=h(e,"node_modules",".bin","textlint");if(n)await l`${r} --fix ${a}`.cwd(e);else await l`${r} ${a}`.cwd(e)}async function Kn(t,n,s,e){if(t==="fmt"){let u=n?[]:["-lint"];u.push("-gitignore_excludes",...s);let o=Bun.spawn(["go","run","github.com/google/yamlfmt/cmd/yamlfmt@v0.20.0",...u],{stdout:"inherit",stderr:"inherit"});if(await o.exited,o.exitCode!==0)process.exit(o.exitCode||1);return}let a=Bun.spawn(["go","run","github.com/rhysd/actionlint/cmd/actionlint@v1.7.9"],{stdout:"inherit",stderr:"inherit"}),r=["go","run","github.com/suzuki-shunsuke/ghalint/cmd/ghalint@v1.5.4","run",...s],i=Bun.spawn(r,{stdout:"inherit",stderr:"inherit"}),[m,c]=await Promise.all([a.exited.then(()=>a.exitCode),i.exited.then(()=>i.exitCode)]);if(m!==0||c!==0)process.exit(1)}async function En(t,n,s){let{checkType:e,lintType:a}=t,r=h(s,"node_modules",".bin");switch(a){case"tsp":{let i=h(r,"tsp");await _n(i,e,t.isFix,n,s);break}case"md":{await Rn(e,t.isFix,n,s);break}case"shell":{await Zn(e,t.isFix,n,s);break}case"actions":{await Kn(e,t.isFix,n,s);break}case"textlint":{await Xn(e,t.isFix,n,s);break}default:{let i=h(r,"biome");await Yn(i,e,t.isFix,n,s)}}}async function F(){let t=Nn(),{config:n,files:s}=Vn();try{if(n.checkType==="coverage")await Hn(s,n.lintType,t);else if(n.checkType==="test")await Un(s,n.lintType,t);else{let e=qn(n.lintType,t),a=s.length>0?s:e;await En(n,a,t)}process.exit(0)}catch{process.exit(1)}}var _=W(O(),1);import{existsSync as H,readFileSync as Fn}from"fs";import{dirname as Dn,join as z,relative as tn,resolve as k}from"path";var b=W(O(),1);function d(t,n,s="info"){let e={info:b.default.blue,success:b.default.green,warning:b.default.yellow,error:b.default.red},a;if(s==="success")a="\u2713";else if(s==="error")a="\u2717";else if(s==="warning")a="\u26A0";else a="\u2192";console.log(`  ${e[s](a)} ${t} ${n}`)}function Tn(t,n="info"){let s={info:b.default.dim,success:b.default.green,warning:b.default.yellow},e;if(n==="success")e="\u2713";else if(n==="warning")e="\u26A0";else e="  ";console.log(`    ${s[n](e)} ${t}`)}class C{message;interval=null;frames=["\u280B","\u2819","\u2839","\u2838","\u283C","\u2834","\u2826","\u2827","\u2807","\u280F"];frameIndex=0;isActive=!1;constructor(t){this.message=t}start(){if(this.isActive)return;this.isActive=!0,this.frameIndex=0,this.interval=setInterval(()=>{let t=this.frames[this.frameIndex%this.frames.length];process.stdout.write(`\r    ${b.default.cyan(t)} ${b.default.dim(this.message)}`),this.frameIndex++},100)}stop(t=!0,n){if(!this.isActive)return;if(this.isActive=!1,this.interval)clearInterval(this.interval),this.interval=null;if(process.stdout.write(`\r${" ".repeat(80)}\r`),n)Tn(n,t?"success":"warning")}}function V(t=process.cwd()){let n=k(t),s=k("/");while(n!==s){let e=z(n,"package.json");if(H(e))return n;n=k(n,"..")}return process.cwd()}function J(t,n){if(!H(t))return null;let s=Dn(t);while(s.startsWith(n)){let e=z(s,"package.json");if(H(e))return s;if(s===n)break;s=k(s,"..")}return null}function nt(t,n){try{let s=z(t,"package.json"),e=Fn(s,"utf-8"),a=JSON.parse(e);return Boolean(a.scripts?.[n])}catch{return!1}}function en(t,n){let s=new Map;for(let e of t){let a=e.startsWith("/")?e:k(n,e),r=J(a,n);if(!r){d("\u26A0\uFE0F",`Skipping ${e}: no package.json found`,"warning");continue}let i=tn(n,r)||"root",m=tn(r,a);if(!s.has(r))s.set(r,{dir:r,name:i,files:[]});s.get(r).files.push(m)}return s}async function sn(t,n,s){if(!nt(t.dir,n))return d("\u26A0\uFE0F",`${t.name}: script "${n}" not found`,"warning"),{success:!1,skipped:!0};let e=new C(`Running ${n} in ${t.name}...`);e.start();try{let a=Bun.spawn(["bun","run",n,"--",...t.files],{cwd:t.dir,stdout:"pipe",stderr:"pipe"}),r=await a.exited;if(e.stop(r===0,`${t.name}: ${n} ${r===0?"completed":"failed"}`),r!==0){let i=await new Response(a.stderr).text();if(i)console.error(_.default.red(`
Error in ${t.name}:`)),console.error(i);return{success:!1,skipped:!1,exitCode:r}}return{success:!0,skipped:!1}}catch(a){return e.stop(!1,`${t.name}: ${n} failed`),console.error(_.default.red(`
Error in ${t.name}:`),a),{success:!1,skipped:!1}}}async function an(t,n,s,e=!0){if(t.size===0)return d("\u2139\uFE0F","No packages to process","info"),!0;let a=Array.from(t.values());if(e){let r=await Promise.all(a.map((c)=>sn(c,n,s))),i=r.map((c,u)=>({result:c,package:a[u]})).filter((c)=>c.result.success&&c.package!==void 0).map(({package:c})=>c.name),m=r.some((c)=>!c.success&&!c.skipped);if(i.length>0)d("\u2713",`Processed ${i.length} package(s): ${i.join(", ")}`,"success");return!m}else{let r=!1,i=[];for(let m of a){let c=await sn(m,n,s);if(c.success)i.push(m.name);else if(!c.skipped)r=!0}if(i.length>0)d("\u2713",`Processed ${i.length} package(s): ${i.join(", ")}`,"success");return!r}}var f=W(O(),1);import{execSync as tt}from"child_process";import{existsSync as st,readFileSync as et}from"fs";var at=[/^infra\/Pulumi\..*\.yaml$/,/\.env$/,/\.env\.local$/,/\.env\..*$/,/^\.git\/config$/,/^\.git\/credentials$/],rn=[/doppler:dopplerToken/i,/secure:/i,/api[_-]?key/i,/apikey/i,/password/i,/passwd/i,/pwd/i,/token/i,/access[_-]?token/i,/refresh[_-]?token/i,/secret/i,/secret[_-]?key/i,/credential/i,/credentials/i,/auth/i,/aws[_-]?access[_-]?key/i,/aws[_-]?secret[_-]?key/i,/private[_-]?key/i,/public[_-]?key/i,/bearer[_-]?token/i,/session[_-]?id/i,/session[_-]?secret/i],cn=[/^[A-Za-z0-9+/]{32,}={0,2}$/,/^[A-Za-z0-9_-]{20,}$/,/^sk-[A-Za-z0-9_-]+$/,/^pk_[A-Za-z0-9_-]+$/,/^ghp_[A-Za-z0-9_-]+$/,/^gho_[A-Za-z0-9_-]+$/,/^ghu_[A-Za-z0-9_-]+$/,/^ghs_[A-Za-z0-9_-]+$/,/^ghr_[A-Za-z0-9_-]+$/,/^AKIA[0-9A-Z]{16}$/,/^AIza[0-9A-Za-z_-]{35}$/,/^ya29\.[0-9A-Za-z_-]+$/,/^xox[baprs]-[0-9a-zA-Z-]{10,48}$/],rt=[/\.example$/,/\.sample$/,/\.template$/,/\.dist$/,/node_modules/,/\.git/,/dist/,/build/,/coverage/,/\.turbo/];function it(){try{return tt("git diff --cached --name-only --diff-filter=ACM",{encoding:"utf-8"}).split(`
`).map((n)=>n.trim()).filter((n)=>n.length>0)}catch(t){return console.error("Error getting staged files:",t),[]}}function ct(t){if(rt.some((n)=>n.test(t)))return!1;return at.some((n)=>n.test(t))}function mt(t){let n=[];if(t.includes("doppler:dopplerToken"))n.push("contains 'doppler:dopplerToken' - use DOPPLER_TOKEN environment variable instead");if(/^\s*secure:/m.test(t))n.push("contains encrypted secrets (secure:) - use environment variables instead");return n}function ut(t){let n=[],s=t.split(`
`);for(let e=0;e<s.length;e++){let a=s[e]?.trim();if(!a||a.startsWith("#")||a.length===0)continue;let r=a.split("=");if(r.length<2)continue;let i=r[0]?.trim();if(!i)continue;let m=r.slice(1).join("=").trim().replaceAll(/(?:^["'])|(?:["']$)/g,"");if(!rn.some((c)=>c.test(i)))continue;if(m.length===0||m==="null"||m==="undefined"||m==="''"||m==='""')continue;if(cn.some((c)=>c.test(m)))n.push(`line ${e+1}: potential secret in '${i}'`);else if(m.length>10)n.push(`line ${e+1}: potential secret in '${i}' (long value detected)`)}return n}function ot(t){let n=[];for(let s of rn){let e=new RegExp(`(${s.source})\\s*[:=]\\s*["']?([^"'
]{10,})["']?`,"gi"),a=t.matchAll(e);for(let r of a){let i=r[2];if(i&&cn.some((m)=>m.test(i)))n.push(`potential hardcoded secret detected: '${r[1]}'`)}}return n}function lt(t){if(!st(t))return{found:!1,issues:[]};let n=et(t,"utf-8"),s=[];if(/^infra\/Pulumi\..*\.yaml$/.test(t))s.push(...mt(n));else if(/\.env/.test(t))s.push(...ut(n));else s.push(...ot(n));return{found:s.length>0,issues:s}}function ht(t){for(let{file:n,issues:s}of t){d("\u274C",n,"error");for(let e of s)console.error(f.default.red(`   ${e}`));console.error()}}function gt(){console.error(),d("\uD83D\uDCA1","Security best practices:","info"),console.error(f.default.dim("   \u2022 Use environment variables instead of hardcoding secrets")),console.error(f.default.dim("   \u2022 Never commit .env files with actual secrets")),console.error(f.default.dim("   \u2022 Use .env.example files for documentation")),console.error(f.default.dim("   \u2022 Use secret management services (e.g., Doppler, AWS Secrets Manager)")),console.error()}function dt(){console.error(f.default.yellow("   For Pulumi config files:")),console.error(f.default.dim("   \u2022 Remove 'doppler:dopplerToken' from config files")),console.error(f.default.dim("   \u2022 Use DOPPLER_TOKEN environment variable instead")),console.error(f.default.dim("   \u2022 See infra/README.md for details")),console.error()}function ft(){console.error(f.default.yellow("   For .env files:")),console.error(f.default.dim("   \u2022 Add .env files to .gitignore")),console.error(f.default.dim("   \u2022 Use .env.example for documentation")),console.error(f.default.dim("   \u2022 Never commit actual secrets")),console.error()}function pt(t){if(console.error(),d("\u274C","Security issues detected:","error"),console.error(),ht(t),gt(),t.filter(({file:e})=>/^infra\/Pulumi\..*\.yaml$/.test(e)).length>0)dt();if(t.filter(({file:e})=>/\.env/.test(e)).length>0)ft()}async function mn(t){let n=t&&t.length>0?t:it();if(n.length===0)return d("\u2139\uFE0F","No files to check","info"),!0;let s=n.filter(ct);if(s.length===0)return d("\u2139\uFE0F","No security-sensitive files to check","info"),!0;let e=[];for(let a of s){let{found:r,issues:i}=lt(a);if(r)e.push({file:a,issues:i})}if(e.length>0)return pt(e),!1;return d("\u2713","No security issues detected","success"),!0}var on=W(O(),1);import{execSync as bt}from"child_process";import{existsSync as xt}from"fs";import{join as $,resolve as wt}from"path";var{$:$t}=globalThis.Bun;function Q(t,n){let s=t.startsWith("/")?t:wt(n,t),e=J(s,n);if(!e)return null;return e.replace(`${n}/`,"")}function Ot(t,n){return t.map((s)=>s.startsWith("/")?s.replace(`${n}/`,""):s).filter((s)=>!s.includes("worker-configuration.d.ts")&&!s.includes("/.astro/")&&!s.includes("/.turbo/")&&!s.includes("/.tanstack/")&&!s.includes("/.wrangler/")&&!s.includes("/build/")&&!s.includes("/dist/")&&!s.includes("/report/")&&!s.includes("/coverage/"))}function Ct(t){return t.filter((n)=>!n.endsWith(".test.ts")&&!n.endsWith(".test.tsx")&&(n.endsWith(".ts")||n.endsWith(".tsx")))}function kt(t,n){return t.filter((s)=>{let a=(s.startsWith("/")?s:`${n}/${s}`).replace(/\.(ts|tsx)$/,".test.$1");return xt(a)})}function Wt(t,n){let s=new Map,e=[];for(let a of t){let r=a.startsWith("/")?a.replace(`${n}/`,""):a,i=Q(r,n);if(i){if(!s.has(i))s.set(i,[]);s.get(i).push(r)}else e.push(r)}return{workspaceGroups:s,rootFiles:e}}function Bt(t,n,s){for(let[e]of t)s.push(`cd ${$(n,e)} && bun run fmt:check && bun run lint`)}function vt(t,n,s){if(t.length===0)return;if(t.filter((a)=>a.endsWith(".ts")||a.endsWith(".tsx")||a.endsWith(".js")||a.endsWith(".jsx")).length>0)s.push(`cd ${n} && bunx turbo run fmt:check`,`cd ${n} && bunx turbo run lint`)}function At(t,n,s){for(let e of t){let a=e.startsWith("/")?e.replace(`${n}/`,""):e,r=Q(a,n),i=a.replace(/\.(ts|tsx)$/,".test.$1");if(r){let m=$(n,r),c=i.replace(`${r}/`,""),u=a.replace(`${r}/`,"");s.push(`cd ${m} && bun run test -- ${c}`,`cd ${m} && bun run coverage -- ${u}`)}}}function un(t,n){let s=Ot(t,n),e=Ct(s),a=kt(e,n),r=s.some((u)=>u.endsWith(".ts")||u.endsWith(".tsx")),{workspaceGroups:i,rootFiles:m}=Wt(s,n),c=[];if(Bt(i,n,c),vt(m,n,c),At(a,n,c),r)c.push(`cd ${n} && bunx turbo run typecheck`);return c}function Mt(t,n){if(n==="*.{ts,tsx}")return t.endsWith(".ts")||t.endsWith(".tsx");if(n==="*.config.js")return t.endsWith(".config.js");if(n==="*.md")return t.endsWith(".md");if(n==="*.sh")return t.endsWith(".sh");if(n==="*.tsp")return t.endsWith(".tsp");if(n==="**/*.test.{ts,tsx}")return t.includes(".test.ts")||t.includes(".test.tsx");if(n.startsWith(".github/")&&n.endsWith("/*.yml"))return t.startsWith(".github/")&&t.endsWith(".yml");return!1}function Nt(){try{return bt("git diff --cached --name-only --diff-filter=ACM",{encoding:"utf-8"}).split(`
`).map((n)=>n.trim()).filter((n)=>n.length>0)}catch(t){return console.error("Error getting staged files:",t),[]}}async function Vt(t){try{return await $t`sh -c ${t}`,!0}catch{return!1}}function jt(t,n){if(!Array.isArray(t)||t.length===0)return[];let s={".github/**/*.yml":(a)=>a.flatMap((r)=>[`bun run fmt:actions:check -- ${r}`,`bun run lint:actions:check -- ${r}`]),"*.{ts,tsx}":(a)=>un(a,n),"*.config.js":(a)=>un(a,n),"*.md":(a)=>{let r=a.filter((c)=>c.includes("apps/wiki/")),i=a.filter((c)=>!c.includes("apps/wiki/")),m=[];if(r.length>0){let c=r.map((u)=>{let o=u.match(/apps\/wiki\/(.+)/);return o?o[1]:u});m.push(`cd ${$(n,"apps/wiki")} && bun run fmt:md:check -- ${c.join(" ")}`,`cd ${$(n,"apps/wiki")} && bun run lint:md:check -- ${c.join(" ")}`,`cd ${$(n,"apps/wiki")} && bun run lint:textlint:check -- ${c.join(" ")}`)}if(i.length>0)d("\u26A0\uFE0F",`The following markdown files are outside apps/wiki/ and will not be checked: ${i.join(", ")}`,"warning");return m},"*.sh":(a)=>a.flatMap((r)=>[`bun run fmt:shell:check -- ${r}`,`bun run lint:shell:check -- ${r}`]),"*.tsp":(a)=>a.flatMap((r)=>[`bun run fmt:tsp:check -- ${r}`,`bun run lint:tsp:check -- ${r}`]),"**/*.test.{ts,tsx}":(a)=>{let r=[];for(let i of a){let m=i.startsWith("/")?i.replace(`${n}/`,""):i,c=Q(m,n);if(c){let u=$(n,c),o=m.replace(`${c}/`,"");r.push(`cd ${u} && bun run test -- ${o}`)}else d("\u26A0\uFE0F",`Test file ${m} is not in a workspace directory and will be skipped`,"warning")}return r}},e=[];for(let[a,r]of Object.entries(s)){let i=t.filter((m)=>Mt(m,a));if(i.length>0){let m=r(i);e.push(...m)}}return e}async function ln(t){let n=V(),s=t&&t.length>0?t:Nt();if(s.length===0)return d("\u2139\uFE0F","No files to process","info"),!0;let e=jt(s,n);if(e.length===0)return d("\u2139\uFE0F","No commands to execute","info"),!0;let a=!1;for(let r of e){let i=new C(`Running: ${r}`);i.start();let m=await Vt(r);if(i.stop(m,m?`Completed: ${r}`:`Failed: ${r}`),!m)a=!0,console.error(on.default.red(`Command failed: ${r}`))}return!a}var w=T("check");w.command("staged","\u30B9\u30C6\u30FC\u30B8\u3055\u308C\u305F\u30D5\u30A1\u30A4\u30EB\u3092\u30C1\u30A7\u30C3\u30AF\u3057\u307E\u3059").option("--files <files...>","\u30C1\u30A7\u30C3\u30AF\u3059\u308B\u30D5\u30A1\u30A4\u30EB\u306E\u30EA\u30B9\u30C8").action(async(t)=>{let n=[];if(Array.isArray(t.files))n=t.files;else if(t.files)n=[t.files];let s=await ln(n.length>0?n:void 0);process.exit(s?0:1)});w.command("secrets","\u30BB\u30AD\u30E5\u30EA\u30C6\u30A3\u95A2\u9023\u306E\u30B7\u30FC\u30AF\u30EC\u30C3\u30C8\u3092\u7DB2\u7F85\u7684\u306B\u30C1\u30A7\u30C3\u30AF\u3057\u307E\u3059").option("--files <files...>","\u30C1\u30A7\u30C3\u30AF\u3059\u308B\u30D5\u30A1\u30A4\u30EB\u306E\u30EA\u30B9\u30C8").action(async(t)=>{let n=t.files||[],s=await mn(n.length>0?n:void 0);process.exit(s?0:1)});w.command("dispatch <command>","\u30D1\u30C3\u30B1\u30FC\u30B8\u3054\u3068\u306B\u30B3\u30DE\u30F3\u30C9\u3092\u5B9F\u884C\u3057\u307E\u3059").option("--files <files...>","\u51E6\u7406\u3059\u308B\u30D5\u30A1\u30A4\u30EB\u306E\u30EA\u30B9\u30C8").option("--no-parallel","\u4E26\u5217\u5B9F\u884C\u3092\u7121\u52B9\u5316").action(async(t,n)=>{let s=V(),e=n.files||[];if(e.length===0)console.error("Error: No files provided"),process.exit(1);let a=en(e,s),r=await an(a,t,s,!n["no-parallel"]);process.exit(r?0:1)});w.command("*","\u65E2\u5B58\u306Echeck\u30B3\u30DE\u30F3\u30C9\u3092\u5B9F\u884C\u3057\u307E\u3059").action(async()=>{await F()});w.help();w.version("1.0.1");w.parse();
