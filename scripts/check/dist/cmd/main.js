#!/usr/bin/env bun
// @bun
var bn=Object.create;var{getPrototypeOf:xn,defineProperty:K,getOwnPropertyNames:wn}=Object;var $n=Object.prototype.hasOwnProperty;var M=(t,n,s)=>{s=t!=null?bn(xn(t)):{};let e=n||!t||!t.__esModule?K(s,"default",{value:t,enumerable:!0}):s;for(let r of wn(t))if(!$n.call(e,r))K(e,r,{get:()=>t[r],enumerable:!0});return e};var kn=(t,n)=>()=>(n||t((n={exports:{}}).exports,n),n.exports);var B=kn((Ut,R)=>{var G=process||{},tn=G.argv||[],q=G.env||{},Dn=!(!!q.NO_COLOR||tn.includes("--no-color"))&&(!!q.FORCE_COLOR||tn.includes("--color")||G.platform==="win32"||(G.stdout||{}).isTTY&&q.TERM!=="dumb"||!!q.CI),nt=(t,n,s=t)=>(e)=>{let r=""+e,a=r.indexOf(n,t.length);return~a?t+tt(r,n,s,a)+n:t+r+n},tt=(t,n,s,e)=>{let r="",a=0;do r+=t.substring(a,e)+s,a=e+n.length,e=t.indexOf(n,a);while(~e);return r+t.substring(a)},sn=(t=Dn)=>{let n=t?nt:()=>String;return{isColorSupported:t,reset:n("\x1B[0m","\x1B[0m"),bold:n("\x1B[1m","\x1B[22m","\x1B[22m\x1B[1m"),dim:n("\x1B[2m","\x1B[22m","\x1B[22m\x1B[2m"),italic:n("\x1B[3m","\x1B[23m"),underline:n("\x1B[4m","\x1B[24m"),inverse:n("\x1B[7m","\x1B[27m"),hidden:n("\x1B[8m","\x1B[28m"),strikethrough:n("\x1B[9m","\x1B[29m"),black:n("\x1B[30m","\x1B[39m"),red:n("\x1B[31m","\x1B[39m"),green:n("\x1B[32m","\x1B[39m"),yellow:n("\x1B[33m","\x1B[39m"),blue:n("\x1B[34m","\x1B[39m"),magenta:n("\x1B[35m","\x1B[39m"),cyan:n("\x1B[36m","\x1B[39m"),white:n("\x1B[37m","\x1B[39m"),gray:n("\x1B[90m","\x1B[39m"),bgBlack:n("\x1B[40m","\x1B[49m"),bgRed:n("\x1B[41m","\x1B[49m"),bgGreen:n("\x1B[42m","\x1B[49m"),bgYellow:n("\x1B[43m","\x1B[49m"),bgBlue:n("\x1B[44m","\x1B[49m"),bgMagenta:n("\x1B[45m","\x1B[49m"),bgCyan:n("\x1B[46m","\x1B[49m"),bgWhite:n("\x1B[47m","\x1B[49m"),blackBright:n("\x1B[90m","\x1B[39m"),redBright:n("\x1B[91m","\x1B[39m"),greenBright:n("\x1B[92m","\x1B[39m"),yellowBright:n("\x1B[93m","\x1B[39m"),blueBright:n("\x1B[94m","\x1B[39m"),magentaBright:n("\x1B[95m","\x1B[39m"),cyanBright:n("\x1B[96m","\x1B[39m"),whiteBright:n("\x1B[97m","\x1B[39m"),bgBlackBright:n("\x1B[100m","\x1B[49m"),bgRedBright:n("\x1B[101m","\x1B[49m"),bgGreenBright:n("\x1B[102m","\x1B[49m"),bgYellowBright:n("\x1B[103m","\x1B[49m"),bgBlueBright:n("\x1B[104m","\x1B[49m"),bgMagentaBright:n("\x1B[105m","\x1B[49m"),bgCyanBright:n("\x1B[106m","\x1B[49m"),bgWhiteBright:n("\x1B[107m","\x1B[49m")}};R.exports=sn();R.exports.createColors=sn});import{EventEmitter as On}from"events";function _(t){return t==null?[]:Array.isArray(t)?t:[t]}function Wn(t,n,s,e){var r,a=t[n],i=~e.string.indexOf(n)?s==null||s===!0?"":String(s):typeof s==="boolean"?s:~e.boolean.indexOf(n)?s==="false"?!1:s==="true"||(t._.push((r=+s,r*0===0)?r:s),!!s):(r=+s,r*0===0)?r:s;t[n]=a==null?i:Array.isArray(a)?a.concat(i):[a,i]}function Cn(t,n){t=t||[],n=n||{};var s,e,r,a,i,o={_:[]},c=0,u=0,m=0,l=t.length;let h=n.alias!==void 0,g=n.unknown!==void 0,x=n.default!==void 0;if(n.alias=n.alias||{},n.string=_(n.string),n.boolean=_(n.boolean),h)for(s in n.alias){e=n.alias[s]=_(n.alias[s]);for(c=0;c<e.length;c++)(n.alias[e[c]]=e.concat(s)).splice(c,1)}for(c=n.boolean.length;c-- >0;){e=n.alias[n.boolean[c]]||[];for(u=e.length;u-- >0;)n.boolean.push(e[u])}for(c=n.string.length;c-- >0;){e=n.alias[n.string[c]]||[];for(u=e.length;u-- >0;)n.string.push(e[u])}if(x){for(s in n.default)if(a=typeof n.default[s],e=n.alias[s]=n.alias[s]||[],n[a]!==void 0){n[a].push(s);for(c=0;c<e.length;c++)n[a].push(e[c])}}let W=g?Object.keys(n.alias):[];for(c=0;c<l;c++){if(r=t[c],r==="--"){o._=o._.concat(t.slice(++c));break}for(u=0;u<r.length;u++)if(r.charCodeAt(u)!==45)break;if(u===0)o._.push(r);else if(r.substring(u,u+3)==="no-"){if(a=r.substring(u+3),g&&!~W.indexOf(a))return n.unknown(r);o[a]=!1}else{for(m=u+1;m<r.length;m++)if(r.charCodeAt(m)===61)break;a=r.substring(u,m),i=r.substring(++m)||(c+1===l||(""+t[c+1]).charCodeAt(0)===45||t[++c]),e=u===2?[a]:a;for(m=0;m<e.length;m++){if(a=e[m],g&&!~W.indexOf(a))return n.unknown("-".repeat(u)+a);Wn(o,a,m+1<e.length||i,n)}}}if(x){for(s in n.default)if(o[s]===void 0)o[s]=n.default[s]}if(h)for(s in o){e=n.alias[s]||[];while(e.length>0)o[e.shift()]=o[s]}return o}var I=(t)=>t.replace(/[<[].+/,"").trim(),Bn=(t)=>{let n=/<([^>]+)>/g,s=/\[([^\]]+)\]/g,e=[],r=(o)=>{let c=!1,u=o[1];if(u.startsWith("..."))u=u.slice(3),c=!0;return{required:o[0].startsWith("<"),value:u,variadic:c}},a;while(a=n.exec(t))e.push(r(a));let i;while(i=s.exec(t))e.push(r(i));return e},vn=(t)=>{let n={alias:{},boolean:[]};for(let[s,e]of t.entries()){if(e.names.length>1)n.alias[e.names[0]]=e.names.slice(1);if(e.isBoolean)if(e.negated){if(!t.some((a,i)=>{return i!==s&&a.names.some((o)=>e.names.includes(o))&&typeof a.required==="boolean"}))n.boolean.push(e.names[0])}else n.boolean.push(e.names[0])}return n},E=(t)=>{return t.sort((n,s)=>{return n.length>s.length?-1:1})[0]},S=(t,n)=>{return t.length>=n?t:`${t}${" ".repeat(n-t.length)}`},An=(t)=>{return t.replace(/([a-z])-([a-z])/g,(n,s,e)=>{return s+e.toUpperCase()})},Mn=(t,n,s)=>{let e=0,r=n.length,a=t,i;for(;e<r;++e)i=a[n[e]],a=a[n[e]]=e===r-1?s:i!=null?i:!!~n[e+1].indexOf(".")||!(+n[e+1]>-1)?{}:[]},jn=(t,n)=>{for(let s of Object.keys(n)){let e=n[s];if(e.shouldTransform){if(t[s]=Array.prototype.concat.call([],t[s]),typeof e.transformFunction==="function")t[s]=t[s].map(e.transformFunction)}}},Nn=(t)=>{let n=/([^\\\/]+)$/.exec(t);return n?n[1]:""},P=(t)=>{return t.split(".").map((n,s)=>{return s===0?An(n):n}).join(".")};class N extends Error{constructor(t){super(t);if(this.name=this.constructor.name,typeof Error.captureStackTrace==="function")Error.captureStackTrace(this,this.constructor);else this.stack=new Error(t).stack}}class T{constructor(t,n,s){if(this.rawName=t,this.description=n,this.config=Object.assign({},s),t=t.replace(/\.\*/g,""),this.negated=!1,this.names=I(t).split(",").map((e)=>{let r=e.trim().replace(/^-{1,2}/,"");if(r.startsWith("no-"))this.negated=!0,r=r.replace(/^no-/,"");return P(r)}).sort((e,r)=>e.length>r.length?1:-1),this.name=this.names[this.names.length-1],this.negated&&this.config.default==null)this.config.default=!0;if(t.includes("<"))this.required=!0;else if(t.includes("["))this.required=!1;else this.isBoolean=!0}}var Vn=process.argv,qn=`${process.platform}-${process.arch} node-${process.version}`;class z{constructor(t,n,s={},e){this.rawName=t,this.description=n,this.config=s,this.cli=e,this.options=[],this.aliasNames=[],this.name=I(t),this.args=Bn(t),this.examples=[]}usage(t){return this.usageText=t,this}allowUnknownOptions(){return this.config.allowUnknownOptions=!0,this}ignoreOptionDefaultValue(){return this.config.ignoreOptionDefaultValue=!0,this}version(t,n="-v, --version"){return this.versionNumber=t,this.option(n,"Display version number"),this}example(t){return this.examples.push(t),this}option(t,n,s){let e=new T(t,n,s);return this.options.push(e),this}alias(t){return this.aliasNames.push(t),this}action(t){return this.commandAction=t,this}isMatched(t){return this.name===t||this.aliasNames.includes(t)}get isDefaultCommand(){return this.name===""||this.aliasNames.includes("!")}get isGlobalCommand(){return this instanceof J}hasOption(t){return t=t.split(".")[0],this.options.find((n)=>{return n.names.includes(t)})}outputHelp(){let{name:t,commands:n}=this.cli,{versionNumber:s,options:e,helpCallback:r}=this.cli.globalCommand,a=[{body:`${t}${s?`/${s}`:""}`}];if(a.push({title:"Usage",body:`  $ ${t} ${this.usageText||this.rawName}`}),(this.isGlobalCommand||this.isDefaultCommand)&&n.length>0){let c=E(n.map((u)=>u.rawName));a.push({title:"Commands",body:n.map((u)=>{return`  ${S(u.rawName,c.length)}  ${u.description}`}).join(`
`)}),a.push({title:"For more info, run any command with the `--help` flag",body:n.map((u)=>`  $ ${t}${u.name===""?"":` ${u.name}`} --help`).join(`
`)})}let o=this.isGlobalCommand?e:[...this.options,...e||[]];if(!this.isGlobalCommand&&!this.isDefaultCommand)o=o.filter((c)=>c.name!=="version");if(o.length>0){let c=E(o.map((u)=>u.rawName));a.push({title:"Options",body:o.map((u)=>{return`  ${S(u.rawName,c.length)}  ${u.description} ${u.config.default===void 0?"":`(default: ${u.config.default})`}`}).join(`
`)})}if(this.examples.length>0)a.push({title:"Examples",body:this.examples.map((c)=>{if(typeof c==="function")return c(t);return c}).join(`
`)});if(r)a=r(a)||a;console.log(a.map((c)=>{return c.title?`${c.title}:
${c.body}`:c.body}).join(`

`))}outputVersion(){let{name:t}=this.cli,{versionNumber:n}=this.cli.globalCommand;if(n)console.log(`${t}/${n} ${qn}`)}checkRequiredArgs(){let t=this.args.filter((n)=>n.required).length;if(this.cli.args.length<t)throw new N(`missing required args for command \`${this.rawName}\``)}checkUnknownOptions(){let{options:t,globalCommand:n}=this.cli;if(!this.config.allowUnknownOptions){for(let s of Object.keys(t))if(s!=="--"&&!this.hasOption(s)&&!n.hasOption(s))throw new N(`Unknown option \`${s.length>1?`--${s}`:`-${s}`}\``)}}checkOptionValue(){let{options:t,globalCommand:n}=this.cli,s=[...n.options,...this.options];for(let e of s){let r=t[e.name.split(".")[0]];if(e.required){let a=s.some((i)=>i.negated&&i.names.includes(e.name));if(r===!0||r===!1&&!a)throw new N(`option \`${e.rawName}\` value is missing`)}}}}class J extends z{constructor(t){super("@@global@@","",{},t)}}var j=Object.assign;class F extends On{constructor(t=""){super();this.name=t,this.commands=[],this.rawArgs=[],this.args=[],this.options={},this.globalCommand=new J(this),this.globalCommand.usage("<command> [options]")}usage(t){return this.globalCommand.usage(t),this}command(t,n,s){let e=new z(t,n||"",s,this);return e.globalCommand=this.globalCommand,this.commands.push(e),e}option(t,n,s){return this.globalCommand.option(t,n,s),this}help(t){return this.globalCommand.option("-h, --help","Display this message"),this.globalCommand.helpCallback=t,this.showHelpOnExit=!0,this}version(t,n="-v, --version"){return this.globalCommand.version(t,n),this.showVersionOnExit=!0,this}example(t){return this.globalCommand.example(t),this}outputHelp(){if(this.matchedCommand)this.matchedCommand.outputHelp();else this.globalCommand.outputHelp()}outputVersion(){this.globalCommand.outputVersion()}setParsedInfo({args:t,options:n},s,e){if(this.args=t,this.options=n,s)this.matchedCommand=s;if(e)this.matchedCommandName=e;return this}unsetMatchedCommand(){this.matchedCommand=void 0,this.matchedCommandName=void 0}parse(t=Vn,{run:n=!0}={}){if(this.rawArgs=t,!this.name)this.name=t[1]?Nn(t[1]):"cli";let s=!0;for(let r of this.commands){let a=this.mri(t.slice(2),r),i=a.args[0];if(r.isMatched(i)){s=!1;let o=j(j({},a),{args:a.args.slice(1)});this.setParsedInfo(o,r,i),this.emit(`command:${i}`,r)}}if(s){for(let r of this.commands)if(r.name===""){s=!1;let a=this.mri(t.slice(2),r);this.setParsedInfo(a,r),this.emit("command:!",r)}}if(s){let r=this.mri(t.slice(2));this.setParsedInfo(r)}if(this.options.help&&this.showHelpOnExit)this.outputHelp(),n=!1,this.unsetMatchedCommand();if(this.options.version&&this.showVersionOnExit&&this.matchedCommandName==null)this.outputVersion(),n=!1,this.unsetMatchedCommand();let e={args:this.args,options:this.options};if(n)this.runMatchedCommand();if(!this.matchedCommand&&this.args[0])this.emit("command:*");return e}mri(t,n){let s=[...this.globalCommand.options,...n?n.options:[]],e=vn(s),r=[],a=t.indexOf("--");if(a>-1)r=t.slice(a+1),t=t.slice(0,a);let i=Cn(t,e);i=Object.keys(i).reduce((l,h)=>{return j(j({},l),{[P(h)]:i[h]})},{_:[]});let o=i._,c={"--":r},u=n&&n.config.ignoreOptionDefaultValue?n.config.ignoreOptionDefaultValue:this.globalCommand.config.ignoreOptionDefaultValue,m=Object.create(null);for(let l of s){if(!u&&l.config.default!==void 0)for(let h of l.names)c[h]=l.config.default;if(Array.isArray(l.config.type)){if(m[l.name]===void 0)m[l.name]=Object.create(null),m[l.name].shouldTransform=!0,m[l.name].transformFunction=l.config.type[0]}}for(let l of Object.keys(i))if(l!=="_"){let h=l.split(".");Mn(c,h,i[l]),jn(c,m)}return{args:o,options:c}}runMatchedCommand(){let{args:t,options:n,matchedCommand:s}=this;if(!s||!s.commandAction)return;s.checkUnknownOptions(),s.checkOptionValue(),s.checkRequiredArgs();let e=[];return s.args.forEach((r,a)=>{if(r.variadic)e.push(t.slice(a));else e.push(t[a])}),e.push(n),s.commandAction.apply(this,e)}}var D=(t="")=>new F(t);import{existsSync as V,readdirSync as Gn}from"fs";import{join as p,relative as Q,resolve as w}from"path";var{$:d}=globalThis.Bun;function yn(t=process.cwd()){let n=w(t),s=w("/");while(n!==s){let e=p(n,"package.json"),r=p(n,"turbo.json");if(V(e)&&V(r))return n;n=w(n,"..")}return process.cwd()}function Ln(){let t=process.argv.slice(2),n="lint",s="ts",e=!1,r=[];for(let a of t)if(a.startsWith("--check-type="))n=a.split("=")[1];else if(a.startsWith("--lint-type="))s=a.split("=")[1];else if(a==="--fix")e=!0;else if(!a.startsWith("--"))r.push(a);return{config:{checkType:n,lintType:s,isFix:e},files:r}}function Un(t,n){let s=w(n,t),e=Q(n,s),r=[/^apps\/([^/]+)/,/^packages\/([^/]+)/,/^tooling\/([^/]+)/,/^testing\/([^/]+)/,/^scripts\/([^/]+)/];for(let a of r){let i=a.exec(e);if(i){let o=i[1];if(o)return o}}return null}function Hn(t,n){switch(t){case"tsp":return[p(n,"packages/api/src/schema/")];case"md":return[p(n,"apps/wiki/docs/")];case"shell":{let s=p(n,".docker"),e=[];try{let r=Gn(s,{recursive:!0}).filter((a)=>a.endsWith(".sh")).map((a)=>p(s,a));e.push(...r)}catch{}return e}case"actions":return[p(n,".github/")];case"textlint":return[p(n,"apps/wiki/docs/")];default:return[p(n,"apps/*/app/"),p(n,"packages/*/src/"),p(n,"tooling/*/src/"),p(n,"testing/*/src/")]}}function _n(t){let n=t.replace(/\.(ts|tsx)$/,".test.$1");return V(n)?n:null}function zn(t){let n=t.replace(/\.test\.(ts|tsx)$/,".$1");return V(n)?n:null}async function Jn(t,n){let s=w(n,t),e=p(n,"node_modules",".bin","vitest"),r=_n(s);if(!r)console.error(`Error: Test file not found for ${t}`),process.exit(1);await d`${e} run --coverage --coverage.include=${s} --coverage.threshold.lines=100 --coverage.threshold.functions=100 --coverage.threshold.branches=100 --coverage.threshold.statements=100 ${r}`.cwd(n).env({NODE_ENV:"test",PATH:process.env.PATH||""})}async function Qn(t,n,s){if(n!=="ts")console.error(`Error: --lint-type=${n} is not supported for test. Only --lint-type=ts is supported.`),process.exit(1);let e=t.map((a)=>w(s,a)),r=p(s,"node_modules",".bin","vitest");await d`${r} run ${e}`.cwd(s).env({NODE_ENV:"test",PATH:process.env.PATH||""})}async function Rn(t,n,s){if(n!=="ts")console.error(`Error: --lint-type=${n} is not supported for coverage. Only --lint-type=ts is supported.`),process.exit(1);let e=p(s,"node_modules",".bin","vitest");if(t.length>0){let r=t.map((a)=>{let i=w(s,a);if(a.includes(".test."))return zn(i);return i}).filter((a)=>a!==null);if(r.length===0)console.error("Error: No source files found"),process.exit(1);for(let a of r)await Jn(Q(s,a),s);return}await d`${e} run --coverage`.cwd(s).env({NODE_ENV:"test",PATH:process.env.PATH||""})}async function Yn(t,n,s,e,r){let a=e.map((i)=>w(r,i));if(n==="fmt"){if(s)await d`${t} format ${a}`.cwd(r);else await d`${t} format --check ${a}`.cwd(r);return}if(s)await d`${t} compile ${a}`.cwd(r);else await d`${t} compile ${a} --warn-as-error`.cwd(r)}function Zn(t,n){if(t==="fmt")return n?"fmt":"fmt:check";return n?"lint:fix":"lint"}async function Xn(t,n,s,e){if(t.size===0)return;let a=Array.from(t).map((o)=>`--filter=${o}`).join(" "),i=Zn(n,s);await d`turbo run ${i} ${a}`.cwd(e)}async function Kn(t,n,s,e,r){if(e.length===0)return;if(n==="fmt")if(s)await d`${t} format --write ${e}`.cwd(r);else await d`${t} format ${e}`.cwd(r);else if(s)await d`${t} lint --write ${e}`.cwd(r);else await d`${t} lint ${e}`.cwd(r)}async function En(t,n,s,e,r){let a=new Set,i=[];for(let o of e){let c=w(r,o),u=Un(c,r);if(u)a.add(u);else i.push(c)}await Xn(a,n,s,r),await Kn(t,n,s,i,r)}async function Sn(t,n,s,e){let r=s.map((i)=>w(e,i));if(t==="fmt"){if(n)await d`remark ${r} --output`.cwd(e);else await d`remark ${r} --frail --quiet`.cwd(e);return}let a=p(e,"node_modules",".bin","markdownlint-cli2");if(n)await d`${a} --fix ${r}`.cwd(e);else await d`${a} ${r}`.cwd(e)}async function In(t,n,s,e){let r=s.map((i)=>w(e,i));if(r.length===0){console.log("No shell files to check");return}if(t==="fmt"){if(n)await d`go run mvdan.cc/sh/v3/cmd/shfmt@v3.12.0 -w ${r}`.cwd(e);else await d`go run mvdan.cc/sh/v3/cmd/shfmt@v3.12.0 -l -d ${r}`.cwd(e);return}let a=r.map((i)=>Q(e,i));await d`docker run --rm -v ${e}:/work -w /work -v ${e}/node_modules:/work/node_modules koalaman/shellcheck:v0.11.0 ${a}`}async function Pn(t,n,s,e){if(t==="fmt")console.error("Error: textlint does not support formatting. Use --check-type=lint instead."),process.exit(1);let r=s.map((i)=>w(e,i)),a=p(e,"node_modules",".bin","textlint");if(n)await d`${a} --fix ${r}`.cwd(e);else await d`${a} ${r}`.cwd(e)}async function Tn(t,n,s,e){if(t==="fmt"){let u=n?[]:["-lint"];u.push("-gitignore_excludes",...s);let m=Bun.spawn(["go","run","github.com/google/yamlfmt/cmd/yamlfmt@v0.20.0",...u],{stdout:"inherit",stderr:"inherit"});if(await m.exited,m.exitCode!==0)process.exit(m.exitCode||1);return}let r=Bun.spawn(["go","run","github.com/rhysd/actionlint/cmd/actionlint@v1.7.9"],{stdout:"inherit",stderr:"inherit"}),a=["go","run","github.com/suzuki-shunsuke/ghalint/cmd/ghalint@v1.5.4","run",...s],i=Bun.spawn(a,{stdout:"inherit",stderr:"inherit"}),[o,c]=await Promise.all([r.exited.then(()=>r.exitCode),i.exited.then(()=>i.exitCode)]);if(o!==0||c!==0)process.exit(1)}async function Fn(t,n,s){let{checkType:e,lintType:r}=t,a=p(s,"node_modules",".bin");switch(r){case"tsp":{let i=p(a,"tsp");await Yn(i,e,t.isFix,n,s);break}case"md":{await Sn(e,t.isFix,n,s);break}case"shell":{await In(e,t.isFix,n,s);break}case"actions":{await Tn(e,t.isFix,n,s);break}case"textlint":{await Pn(e,t.isFix,n,s);break}default:{let i=p(a,"biome");await En(i,e,t.isFix,n,s)}}}async function nn(){let t=yn(),{config:n,files:s}=Ln();try{if(n.checkType==="coverage")await Rn(s,n.lintType,t);else if(n.checkType==="test")await Qn(s,n.lintType,t);else{let e=Hn(n.lintType,t),r=s.length>0?s:e;await Fn(n,r,t)}process.exit(0)}catch{process.exit(1)}}var hn=M(B(),1);import{execSync as ct}from"child_process";import{existsSync as ot}from"fs";import{join as k}from"path";var{$:ut}=globalThis.Bun;var Z=M(B(),1);import{existsSync as Y,readFileSync as et}from"fs";import{dirname as rt,join as X,relative as en,resolve as A}from"path";var $=M(B(),1);function f(t,n,s="info"){let e={info:$.default.blue,success:$.default.green,warning:$.default.yellow,error:$.default.red},r;if(s==="success")r="\u2713";else if(s==="error")r="\u2717";else if(s==="warning")r="\u26A0";else r="\u2192";console.log(`  ${e[s](r)} ${t} ${n}`)}function st(t,n="info"){let s={info:$.default.dim,success:$.default.green,warning:$.default.yellow},e;if(n==="success")e="\u2713";else if(n==="warning")e="\u26A0";else e="  ";console.log(`    ${s[n](e)} ${t}`)}class v{message;interval=null;frames=["\u280B","\u2819","\u2839","\u2838","\u283C","\u2834","\u2826","\u2827","\u2807","\u280F"];frameIndex=0;isActive=!1;constructor(t){this.message=t}start(){if(this.isActive)return;this.isActive=!0,this.frameIndex=0,this.interval=setInterval(()=>{let t=this.frames[this.frameIndex%this.frames.length];process.stdout.write(`\r    ${$.default.cyan(t)} ${$.default.dim(this.message)}`),this.frameIndex++},100)}stop(t=!0,n){if(!this.isActive)return;if(this.isActive=!1,this.interval)clearInterval(this.interval),this.interval=null;if(process.stdout.write(`\r${" ".repeat(80)}\r`),n)st(n,t?"success":"warning")}}function y(t=process.cwd()){let n=A(t),s=A("/");while(n!==s){let e=X(n,"package.json");if(Y(e))return n;n=A(n,"..")}return process.cwd()}function at(t,n){if(!Y(t))return null;let s=rt(t);while(s.startsWith(n)){let e=X(s,"package.json");if(Y(e))return s;if(s===n)break;s=A(s,"..")}return null}function it(t,n){try{let s=X(t,"package.json"),e=et(s,"utf-8"),r=JSON.parse(e);return Boolean(r.scripts?.[n])}catch{return!1}}function an(t,n){let s=new Map;for(let e of t){let r=e.startsWith("/")?e:A(n,e),a=at(r,n);if(!a){f("\u26A0\uFE0F",`Skipping ${e}: no package.json found`,"warning");continue}let i=en(n,a)||"root",o=en(a,r);if(!s.has(a))s.set(a,{dir:a,name:i,files:[]});s.get(a).files.push(o)}return s}async function rn(t,n,s){if(!it(t.dir,n))return f("\u26A0\uFE0F",`${t.name}: script "${n}" not found`,"warning"),{success:!1,skipped:!0};let e=new v(`Running ${n} in ${t.name}...`);e.start();try{let r=Bun.spawn(["bun","run",n,"--",...t.files],{cwd:t.dir,stdout:"pipe",stderr:"pipe"}),a=await r.exited;if(e.stop(a===0,`${t.name}: ${n} ${a===0?"completed":"failed"}`),a!==0){let i=await new Response(r.stderr).text();if(i)console.error(Z.default.red(`
Error in ${t.name}:`)),console.error(i);return{success:!1,skipped:!1,exitCode:a}}return{success:!0,skipped:!1}}catch(r){return e.stop(!1,`${t.name}: ${n} failed`),console.error(Z.default.red(`
Error in ${t.name}:`),r),{success:!1,skipped:!1}}}async function cn(t,n,s,e=!0){if(t.size===0)return f("\u2139\uFE0F","No packages to process","info"),!0;let r=Array.from(t.values());if(e){let a=await Promise.all(r.map((c)=>rn(c,n,s))),i=a.map((c,u)=>({result:c,package:r[u]})).filter((c)=>c.result.success&&c.package!==void 0).map(({package:c})=>c.name),o=a.some((c)=>!c.success&&!c.skipped);if(i.length>0)f("\u2713",`Processed ${i.length} package(s): ${i.join(", ")}`,"success");return!o}else{let a=!1,i=[];for(let o of r){let c=await rn(o,n,s);if(c.success)i.push(o.name);else if(!c.skipped)a=!0}if(i.length>0)f("\u2713",`Processed ${i.length} package(s): ${i.join(", ")}`,"success");return!a}}function L(t){let n=[/^apps\/([^/]+)/,/^packages\/([^/]+)/,/^tooling\/([^/]+)/,/^testing\/([^/]+)/,/^scripts\/([^/]+)/,/^generators\/([^/]+)/,/^infra\/([^/]+)/];for(let s of n){let e=t.match(s);if(e)return e[0]}return null}function on(t,n){return t.map((s)=>s.startsWith("/")?s.replace(`${n}/`,""):s).filter((s)=>!s.includes("worker-configuration.d.ts")&&!s.includes("/.astro/")&&!s.includes("/.turbo/")&&!s.includes("/.tanstack/")&&!s.includes("/.wrangler/")&&!s.includes("/build/")&&!s.includes("/dist/")&&!s.includes("/report/")&&!s.includes("/coverage/"))}function un(t){return t.filter((n)=>!n.endsWith(".test.ts")&&!n.endsWith(".test.tsx")&&(n.endsWith(".ts")||n.endsWith(".tsx")))}function mn(t,n){return t.filter((s)=>{let r=(s.startsWith("/")?s:`${n}/${s}`).replace(/\.(ts|tsx)$/,".test.$1");return ot(r)})}function ln(t,n){let s=new Map,e=[];for(let r of t){let a=r.startsWith("/")?r.replace(`${n}/`,""):r,i=L(a);if(i){if(!s.has(i))s.set(i,[]);s.get(i).push(a)}else e.push(a)}return{workspaceGroups:s,rootFiles:e}}function mt(){try{return ct("git diff --cached --name-only --diff-filter=ACM",{encoding:"utf-8"}).split(`
`).map((n)=>n.trim()).filter((n)=>n.length>0)}catch(t){return console.error("Error getting staged files:",t),[]}}async function lt(t){try{return await ut`${t}`.quiet(),!0}catch{return!1}}async function ht(t,n){let s={".github/**/*.yml":(r)=>r.flatMap((a)=>[`bun run fmt:actions:check -- ${a}`,`bun run lint:actions:check -- ${a}`]),"*.{ts,tsx}":(r)=>{let a=on(r,n),i=un(a),o=mn(i,n),c=a.some((h)=>h.endsWith(".ts")||h.endsWith(".tsx")),{workspaceGroups:u,rootFiles:m}=ln(a,n),l=[];for(let[h]of u)l.push(`cd ${k(n,h)} && bun run fmt:check && bun run lint`);if(m.length>0){if(m.filter((g)=>g.endsWith(".ts")||g.endsWith(".tsx")||g.endsWith(".js")||g.endsWith(".jsx")).length>0)l.push("turbo run fmt:check","turbo run lint")}for(let h of o){let g=h.startsWith("/")?h.replace(`${n}/`,""):h,x=L(g),W=g.replace(/\.(ts|tsx)$/,".test.$1");if(x){let C=k(n,x),U=W.replace(`${x}/`,""),H=g.replace(`${x}/`,"");l.push(`cd ${C} && bun run test -- ${U}`,`cd ${C} && bun run coverage -- ${H}`)}}if(c)l.push("turbo run typecheck");return l},"*.config.js":(r)=>{let a=on(r,n),i=un(a),o=mn(i,n),c=a.some((h)=>h.endsWith(".ts")||h.endsWith(".tsx")),{workspaceGroups:u,rootFiles:m}=ln(a,n),l=[];for(let[h]of u)l.push(`cd ${k(n,h)} && bun run fmt:check && bun run lint`);if(m.length>0){if(m.filter((g)=>g.endsWith(".ts")||g.endsWith(".tsx")||g.endsWith(".js")||g.endsWith(".jsx")).length>0)l.push("turbo run fmt:check","turbo run lint")}for(let h of o){let g=h.startsWith("/")?h.replace(`${n}/`,""):h,x=L(g),W=g.replace(/\.(ts|tsx)$/,".test.$1");if(x){let C=k(n,x),U=W.replace(`${x}/`,""),H=g.replace(`${x}/`,"");l.push(`cd ${C} && bun run test -- ${U}`,`cd ${C} && bun run coverage -- ${H}`)}}if(c)l.push("turbo run typecheck");return l},"*.md":(r)=>{let a=r.filter((c)=>c.includes("apps/wiki/")),i=r.filter((c)=>!c.includes("apps/wiki/")),o=[];if(a.length>0){let c=a.map((u)=>{let m=u.match(/apps\/wiki\/(.+)/);return m?m[1]:u});o.push(`cd ${k(n,"apps/wiki")} && bun run fmt:md:check -- ${c.join(" ")}`,`cd ${k(n,"apps/wiki")} && bun run lint:md:check -- ${c.join(" ")}`,`cd ${k(n,"apps/wiki")} && bun run lint:textlint:check -- ${c.join(" ")}`)}if(i.length>0)f("\u26A0\uFE0F",`The following markdown files are outside apps/wiki/ and will not be checked: ${i.join(", ")}`,"warning");return o},"*.sh":(r)=>r.flatMap((a)=>[`bun run fmt:shell:check -- ${a}`,`bun run lint:shell:check -- ${a}`]),"*.tsp":(r)=>r.flatMap((a)=>[`bun run fmt:tsp:check -- ${a}`,`bun run lint:tsp:check -- ${a}`]),"**/*.test.{ts,tsx}":(r)=>{let a=[];for(let i of r){let o=i.startsWith("/")?i.replace(`${n}/`,""):i,c=L(o);if(c){let u=k(n,c),m=o.replace(`${c}/`,"");a.push(`cd ${u} && bun run test -- ${m}`)}else f("\u26A0\uFE0F",`Test file ${o} is not in a workspace directory and will be skipped`,"warning")}return a}},e=[];for(let[r,a]of Object.entries(s)){let i=t.filter((o)=>{if(r==="*.{ts,tsx}")return o.endsWith(".ts")||o.endsWith(".tsx");if(r==="*.config.js")return o.endsWith(".config.js");if(r==="*.md")return o.endsWith(".md");if(r==="*.sh")return o.endsWith(".sh");if(r==="*.tsp")return o.endsWith(".tsp");if(r==="**/*.test.{ts,tsx}")return o.includes(".test.ts")||o.includes(".test.tsx");if(r.startsWith(".github/")&&r.endsWith("/*.yml"))return o.startsWith(".github/")&&o.endsWith(".yml");return!1});if(i.length>0){let o=a(i);e.push(...o)}}return e}async function gn(t){let n=y(),s=t&&t.length>0?t:mt();if(s.length===0)return f("\u2139\uFE0F","No files to process","info"),!0;let e=await ht(s,n);if(e.length===0)return f("\u2139\uFE0F","No commands to execute","info"),!0;let r=!1;for(let a of e){let i=new v(`Running: ${a}`);i.start();let o=await lt(a);if(i.stop(o,o?`Completed: ${a}`:`Failed: ${a}`),!o)r=!0,console.error(hn.default.red(`Command failed: ${a}`))}return!r}var b=M(B(),1);import{execSync as gt}from"child_process";import{existsSync as dt,readFileSync as pt}from"fs";var ft=[/^infra\/Pulumi\..*\.yaml$/,/\.env$/,/\.env\.local$/,/\.env\..*$/,/^\.git\/config$/,/^\.git\/credentials$/],dn=[/doppler:dopplerToken/i,/secure:/i,/api[_-]?key/i,/apikey/i,/password/i,/passwd/i,/pwd/i,/token/i,/access[_-]?token/i,/refresh[_-]?token/i,/secret/i,/secret[_-]?key/i,/credential/i,/credentials/i,/auth/i,/aws[_-]?access[_-]?key/i,/aws[_-]?secret[_-]?key/i,/private[_-]?key/i,/public[_-]?key/i,/bearer[_-]?token/i,/session[_-]?id/i,/session[_-]?secret/i],pn=[/^[A-Za-z0-9+/]{32,}={0,2}$/,/^[A-Za-z0-9_-]{20,}$/,/^sk-[A-Za-z0-9_-]+$/,/^pk_[A-Za-z0-9_-]+$/,/^ghp_[A-Za-z0-9_-]+$/,/^gho_[A-Za-z0-9_-]+$/,/^ghu_[A-Za-z0-9_-]+$/,/^ghs_[A-Za-z0-9_-]+$/,/^ghr_[A-Za-z0-9_-]+$/,/^AKIA[0-9A-Z]{16}$/,/^AIza[0-9A-Za-z_-]{35}$/,/^ya29\.[0-9A-Za-z_-]+$/,/^xox[baprs]-[0-9a-zA-Z-]{10,48}$/],bt=[/\.example$/,/\.sample$/,/\.template$/,/\.dist$/,/node_modules/,/\.git/,/dist/,/build/,/coverage/,/\.turbo/];function xt(){try{return gt("git diff --cached --name-only --diff-filter=ACM",{encoding:"utf-8"}).split(`
`).map((n)=>n.trim()).filter((n)=>n.length>0)}catch(t){return console.error("Error getting staged files:",t),[]}}function wt(t){if(bt.some((n)=>n.test(t)))return!1;return ft.some((n)=>n.test(t))}function $t(t){let n=[];if(t.includes("doppler:dopplerToken"))n.push("contains 'doppler:dopplerToken' - use DOPPLER_TOKEN environment variable instead");if(/^\s*secure:/m.test(t))n.push("contains encrypted secrets (secure:) - use environment variables instead");return n}function kt(t){let n=[],s=t.split(`
`);for(let e=0;e<s.length;e++){let r=s[e]?.trim();if(!r||r.startsWith("#")||r.length===0)continue;let a=r.split("=");if(a.length<2)continue;let i=a[0]?.trim();if(!i)continue;let o=a.slice(1).join("=").trim().replaceAll(/(?:^["'])|(?:["']$)/g,"");if(!dn.some((c)=>c.test(i)))continue;if(o.length===0||o==="null"||o==="undefined"||o==="''"||o==='""')continue;if(pn.some((c)=>c.test(o)))n.push(`line ${e+1}: potential secret in '${i}'`);else if(o.length>10)n.push(`line ${e+1}: potential secret in '${i}' (long value detected)`)}return n}function Ot(t){let n=[];for(let s of dn){let e=new RegExp(`(${s.source})\\s*[:=]\\s*["']?([^"'
]{10,})["']?`,"gi"),r=t.matchAll(e);for(let a of r){let i=a[2];if(i&&pn.some((o)=>o.test(i)))n.push(`potential hardcoded secret detected: '${a[1]}'`)}}return n}function Wt(t){if(!dt(t))return{found:!1,issues:[]};let n=pt(t,"utf-8"),s=[];if(/^infra\/Pulumi\..*\.yaml$/.test(t))s.push(...$t(n));else if(/\.env/.test(t))s.push(...kt(n));else s.push(...Ot(n));return{found:s.length>0,issues:s}}function Ct(t){for(let{file:n,issues:s}of t){f("\u274C",n,"error");for(let e of s)console.error(b.default.red(`   ${e}`));console.error()}}function Bt(){console.error(),f("\uD83D\uDCA1","Security best practices:","info"),console.error(b.default.dim("   \u2022 Use environment variables instead of hardcoding secrets")),console.error(b.default.dim("   \u2022 Never commit .env files with actual secrets")),console.error(b.default.dim("   \u2022 Use .env.example files for documentation")),console.error(b.default.dim("   \u2022 Use secret management services (e.g., Doppler, AWS Secrets Manager)")),console.error()}function vt(){console.error(b.default.yellow("   For Pulumi config files:")),console.error(b.default.dim("   \u2022 Remove 'doppler:dopplerToken' from config files")),console.error(b.default.dim("   \u2022 Use DOPPLER_TOKEN environment variable instead")),console.error(b.default.dim("   \u2022 See infra/README.md for details")),console.error()}function At(){console.error(b.default.yellow("   For .env files:")),console.error(b.default.dim("   \u2022 Add .env files to .gitignore")),console.error(b.default.dim("   \u2022 Use .env.example for documentation")),console.error(b.default.dim("   \u2022 Never commit actual secrets")),console.error()}function Mt(t){if(console.error(),f("\u274C","Security issues detected:","error"),console.error(),Ct(t),Bt(),t.filter(({file:e})=>/^infra\/Pulumi\..*\.yaml$/.test(e)).length>0)vt();if(t.filter(({file:e})=>/\.env/.test(e)).length>0)At()}async function fn(t){let n=t&&t.length>0?t:xt();if(n.length===0)return f("\u2139\uFE0F","No files to check","info"),!0;let s=n.filter(wt);if(s.length===0)return f("\u2139\uFE0F","No security-sensitive files to check","info"),!0;let e=[];for(let r of s){let{found:a,issues:i}=Wt(r);if(a)e.push({file:r,issues:i})}if(e.length>0)return Mt(e),!1;return f("\u2713","No security issues detected","success"),!0}var O=D("check");O.command("staged","\u30B9\u30C6\u30FC\u30B8\u3055\u308C\u305F\u30D5\u30A1\u30A4\u30EB\u3092\u30C1\u30A7\u30C3\u30AF\u3057\u307E\u3059").option("--files <files...>","\u30C1\u30A7\u30C3\u30AF\u3059\u308B\u30D5\u30A1\u30A4\u30EB\u306E\u30EA\u30B9\u30C8").action(async(t)=>{let n=t.files||[],s=await gn(n.length>0?n:void 0);process.exit(s?0:1)});O.command("secrets","\u30BB\u30AD\u30E5\u30EA\u30C6\u30A3\u95A2\u9023\u306E\u30B7\u30FC\u30AF\u30EC\u30C3\u30C8\u3092\u7DB2\u7F85\u7684\u306B\u30C1\u30A7\u30C3\u30AF\u3057\u307E\u3059").option("--files <files...>","\u30C1\u30A7\u30C3\u30AF\u3059\u308B\u30D5\u30A1\u30A4\u30EB\u306E\u30EA\u30B9\u30C8").action(async(t)=>{let n=t.files||[],s=await fn(n.length>0?n:void 0);process.exit(s?0:1)});O.command("dispatch <command>","\u30D1\u30C3\u30B1\u30FC\u30B8\u3054\u3068\u306B\u30B3\u30DE\u30F3\u30C9\u3092\u5B9F\u884C\u3057\u307E\u3059").option("--files <files...>","\u51E6\u7406\u3059\u308B\u30D5\u30A1\u30A4\u30EB\u306E\u30EA\u30B9\u30C8").option("--no-parallel","\u4E26\u5217\u5B9F\u884C\u3092\u7121\u52B9\u5316").action(async(t,n)=>{let s=y(),e=n.files||[];if(e.length===0)console.error("Error: No files provided"),process.exit(1);let r=an(e,s),a=await cn(r,t,s,!n["no-parallel"]);process.exit(a?0:1)});O.command("*","\u65E2\u5B58\u306Echeck\u30B3\u30DE\u30F3\u30C9\u3092\u5B9F\u884C\u3057\u307E\u3059").action(async()=>{await nn()});O.help();O.version("1.0.1");O.parse();
