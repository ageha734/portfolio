#!/usr/bin/env bun
// @bun
import{copyFileSync as h,existsSync as a,readFileSync as P,writeFileSync as S}from"node:fs";import{join as c,resolve as g}from"node:path";import{$ as r}from"bun";function L(o=process.cwd()){let e=g(o),n=g("/");while(e!==n){let s=c(e,"package.json"),t=c(e,"turbo.json");if(a(s)&&a(t))return e;e=g(e,"..")}return process.cwd()}async function E(){try{return await r`bun --version`.quiet(),!0}catch{return!1}}async function M(o){let e=c(o,".env.example"),n=c(o,".env");if(a(n)){console.log("✓ .envファイルは既に存在します");return}if(a(e))console.log("\uD83D\uDCDD .env.exampleから.envファイルを作成しています..."),h(e,n),console.log("✓ .envファイルを作成しました");else console.log("⚠️  .env.exampleが見つかりません。空の.envファイルを作成します..."),S(n,`# Environment variables
`),console.log("✓ 空の.envファイルを作成しました")}async function D(o){if(process.env.SKIP_INSTALL==="true"){console.log("⏭️  SKIP_INSTALLが設定されているため、依存関係のインストールをスキップします");return}console.log("\uD83D\uDCE6 依存関係をインストールしています...");try{await r`bun install`.cwd(o),console.log("✓ 依存関係のインストールが完了しました")}catch(e){throw console.error("✗ 依存関係のインストールに失敗しました:",e),e}}async function Q(o){console.log("\uD83D\uDDC4️  Prismaスキーマを生成しています...");try{await r`bun run generate`.cwd(c(o,"packages/db")),console.log("✓ Prismaスキーマの生成が完了しました")}catch(e){console.warn("⚠️  Prismaスキーマの生成に失敗しました（スキップ）:",e)}}async function R(){try{return await r`docker --version`.quiet(),!0}catch{return!1}}async function q(o){try{return(await r`docker ps -a --filter name=^${o}$ --format {{.Names}}`.quiet()).stdout.toString().trim()===o}catch{return!1}}async function v(o){try{return(await r`docker ps --filter name=^${o}$ --format {{.Names}}`.quiet()).stdout.toString().trim()===o}catch{return!1}}async function b(o){try{return(await r`docker images --format {{.Repository}}:{{.Tag}}`.quiet()).stdout.toString().trim().split(`
`).some((s)=>s.startsWith(`${o}:`)||s===o)}catch{return!1}}async function y(o,e=30){console.log("  MySQLの起動を待機しています...");let n=process.env.MYSQL_ROOT_PASSWORD||"rootpassword";for(let s=0;s<e;s++){try{if((await r`docker exec ${o} mysqladmin ping -h localhost -u root -p${n}`.quiet()).exitCode===0)return console.log("  ✓ MySQLが起動しました"),!0}catch{}await new Promise((t)=>setTimeout(t,1000))}return!1}async function _(o){let n=c(o,".docker/db"),s=c(n,"Dockerfile");if(!a(s)){console.log("  ⚠️  MySQL Dockerfileが見つかりません（スキップ）");return}try{if(!await R()){console.warn("  ⚠️  Dockerがインストールされていません（スキップ）");return}if(await b("db"))console.log("  ✓ MySQL Dockerイメージは既に存在します（スキップ）");else console.log("  MySQL Dockerイメージをビルドしています..."),await r`docker build -t db -f ${s} ${n}`.cwd(o),console.log("  ✓ MySQL Dockerイメージのビルドが完了しました");if(await q("db"))if(await v("db")){console.log("  ✓ MySQLコンテナは既に起動しています"),await y("db");return}else{console.log("  MySQLコンテナを起動しています..."),await r`docker start ${"db"}`.cwd(o),await y("db");return}console.log("  MySQLコンテナを作成して起動しています...");let l=process.env.MYSQL_ROOT_PASSWORD||"rootpassword",u=process.env.MYSQL_DATABASE||"portfolio",m=process.env.MYSQL_USER||"user",d=process.env.MYSQL_PASSWORD||"password";if(await r`docker run -d \
            --name ${"db"} \
            -p 3306:3306 \
            -e MYSQL_ROOT_PASSWORD=${l} \
            -e MYSQL_DATABASE=${u} \
            -e MYSQL_USER=${m} \
            -e MYSQL_PASSWORD=${d} \
            -v db-data:/var/lib/mysql \
            db`.cwd(o),console.log("  ✓ MySQLコンテナが起動しました"),!await y("db"))console.warn("  ⚠️  MySQLの起動確認がタイムアウトしました")}catch(t){console.warn("  ⚠️  MySQLコンテナの起動に失敗しました（スキップ）:",t)}}async function $(o){if(console.log("\uD83D\uDD04 データベースマイグレーションを実行しています..."),await v("db")){console.log("  ローカルMySQLに対してマイグレーションを実行しています...");let s=c(o,"packages/db"),t=c(s,"prisma/schema.prisma"),p=process.env.MYSQL_USER||"user",w=process.env.MYSQL_PASSWORD||"password",l=process.env.MYSQL_DATABASE||"portfolio",u=process.env.MYSQL_HOST||"localhost",m=process.env.MYSQL_PORT||"3306",d=`mysql://${p}:${w}@${u}:${m}/${l}`;try{let i=P(t,"utf-8"),f=i.replace(/provider\s*=\s*"sqlite"/,'provider = "mysql"');S(t,f);try{await r`DATABASE_URL=${d} bun run push`.cwd(s),console.log("✓ データベースマイグレーションが完了しました")}finally{S(t,i)}}catch(i){console.warn("⚠️  データベースマイグレーションに失敗しました（スキップ）:",i)}}else{console.log("  Cloudflare D1に対してマイグレーションを実行しています...");try{await r`bun run migrate`.cwd(c(o,"packages/db")),console.log("✓ データベースマイグレーションが完了しました")}catch(s){console.warn("⚠️  データベースマイグレーションに失敗しました（スキップ）:",s)}}}async function A(o){console.log("\uD83D\uDC33 Dockerイメージをビルドしています...");let e=c(o,".docker/e2e/Dockerfile");if(a(e))try{if(await b("e2e"))console.log("  ✓ E2E用Dockerイメージは既に存在します（スキップ）");else console.log("  E2E用Dockerイメージをビルドしています..."),await r`docker build -t e2e -f ${e} .`.cwd(o),console.log("  ✓ E2E用Dockerイメージのビルドが完了しました")}catch(n){console.warn("  ⚠️  E2E用Dockerイメージのビルドに失敗しました（スキップ）:",n)}await _(o)}async function k(){let o=L();if(console.log(`\uD83D\uDE80 開発環境のセットアップを開始します...
`),!await E())console.error("✗ Bunがインストールされていません。"),console.error("  Bunをインストールしてください: https://bun.sh"),process.exit(1);console.log(`✓ Bunがインストールされています
`);let n=process.env.SKIP_INSTALL==="true"||process.env.BUN_LIFECYCLE_EVENT==="prepare";try{if(await M(o),n)console.log("\uD83D\uDCE6 依存関係のインストールをスキップしました（prepareスクリプトから実行中）");else await D(o);await Q(o),await A(o),await $(o),console.log(`
✅ セットアップが完了しました！`),console.log(`
次のステップ:`),console.log("  - .envファイルを編集して環境変数を設定してください"),console.log("  - bun run dev で開発サーバーを起動できます")}catch(s){console.error(`
✗ セットアップ中にエラーが発生しました:`,s),process.exit(1)}}k();
